<gel:script 
 xmlns:core="jelly:core" 
    xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
    xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary"
    xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"	    
    xmlns:sql="jelly:sql"
    xmlns:xog="http://www.niku.com/xog"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
    xmlns:util="jelly:util"
    xmlns:q="http://www.niku.com/xog/Query">
	
	<core:set var="vStudioProjectID" value="${gel_objectInstanceId}"/>
	
	<core:if test="${DebugLevel &gt; 0}">
		<gel:log level="debug" message="Start Script"/>
		<gel:log level="debug" message=">>Studio Project: ${vStudioProjectID}"/> 
		<gel:log level="debug" message=">>Persisted XOG URL   	: ${XOGURL}"/> 
		<gel:log level="debug" message=">>Persisted LOG Folder	: ${XOGlogFolder}"/> 
		<gel:log level="debug" message=">>Persisted WEB Folder	: ${XOGwebFolder}"/> 
		<gel:log level="debug" message=">>Persisted WEB Path	: ${XOGwebPath}"/> 
		<gel:log level="debug" message=">>Persisted DB Vendor	: ${dbVendor}"/> 
		<gel:log level="debug" message=">>Persisted SessionID 	: ${sessionID}"/> 
		<gel:log level="debug" message=">>Persisted DebugLevel	: ${DebugLevel}"/> 
	</core:if>

    <gel:setDataSource dbId="Niku"/>
	
	<sql:query escapeText="false" var="vProject">
		select SP.PROJECT_CODE, SP.PACKAGING_PATH, SP.OUT_FOLDER_PATH, SP.XOG_HOME, CI.XOG_URL, CI.XOG_USERNAME, CI.XOG_PASSWORD, CI.XOG_PORT, Case CI.SSLENABLED when 0 then 'False' else 'True' end SSLENABLED, SP.ST_INCLUDE, CI.XOG_JAVA_PATH, SP.INCLUDE_CM
		from odf_ca_stproj_project SP, odf_ca_stproj_clarity_inst CI
		Where SP.id = ${vStudioProjectID}
		AND SP.target_instance = CI.code
	</sql:query>
	<core:forEach items="${vProject.rowsByIndex}" var="row">
		<core:set var="vProjectCode">${row[0]}</core:set>
		<core:set var="vPackagingPath">${row[1]}</core:set>
		<core:set var="vInputPath">${row[2]}</core:set>
		<core:set var="vOutputPath" value="${vInputPath}/output"/>
		<core:set var="vXOGHome">${row[3]}</core:set>
		<core:set var="vServername">${row[4]}</core:set>
		<core:set var="vXOGUser">${row[5]}</core:set>
		<core:set var="vXOGPassword">${row[6]}</core:set>
		<core:set var="vXOGPort">${row[7]}</core:set>
		<core:set var="vSSL">${row[8]}</core:set>
		<core:set var="vInclude">${row[9]}</core:set>
		<core:set var="vXOGJava">${row[10]}</core:set>
		<core:set var="vIncludeCM">${row[11]}</core:set>
		<core:if test="${DebugLevel &gt; 1}">
			<gel:log level="debug" message="vProjectCode  : ${vProjectCode}"/> 
			<gel:log level="debug" message="vPackagingPath: ${vPackagingPath}"/> 
			<gel:log level="debug" message="vInputPath   : ${vInputPath}"/> 
			<gel:log level="debug" message="vOutputPath   : ${vOutputPath}"/> 
			<gel:log level="debug" message="vXOGHome      : ${vXOGHome}"/> 
			<gel:log level="debug" message="vServername   : ${vServername}"/> 
			<gel:log level="debug" message="vXOGUser      : ${vXOGUser}"/> 
			<gel:log level="debug" message="vXOGPassword  : ${vXOGPassword}"/> 
			<gel:log level="debug" message="vXOGPort      : ${vXOGPort}"/> 
			<gel:log level="debug" message="vSSL          : ${vSSL}"/> 
			<gel:log level="debug" message="vInclude      : ${vInclude}"/> 
			<gel:log level="debug" message="vXOGJava      : ${vXOGJava}"/> 
			<gel:log level="debug" message="vIncludeCM    : ${vIncludeCM}"/> 
		</core:if>
	</core:forEach>

	<core:set var="vFileName">${vPackagingPath}/${vProjectCode}Install.bat</core:set>
	<core:if test="${DebugLevel &gt; 0}">
		<gel:log level="debug" message="Creating File: ${vFileName}"/> 
	</core:if>
	
	<file:writeFile fileName="${vFileName}" delimiter="" embedded="0">
		<core:set var="vLine">@Echo Off</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET XOG_HOME=${vXOGHome}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET SERVERNAME=${vServername}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET PORTNUMBER=${vXOGPort}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET SSLENABLED=${vSSL}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET USERNAME=${vXOGUser}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET PASSWORD=${vXOGPassword}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">SET JAVA_HOME=${vXOGJava}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">CD ${vInputPath}</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
		<core:set var="vLine">IF NOT EXIST output md output</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>

		<sql:query escapeText="false" var="vProjectFiles">
			select filename, output_filename 
			from ODF_CA_STPROJ_FILE
			Where ODF_PARENT_ID = ${vStudioProjectID}
			AND ELEMENT_TYPE != 'demodata'
			AND IS_POST_FILE != 1
			ORDER BY sort_order
		</sql:query>
		<core:forEach items="${vProjectFiles.rowsByIndex}" var="row">
			<core:set var="vFileIN">${row[0]}</core:set>
			<core:set var="vFileOUT">${row[1]}</core:set>
			<core:if test="${DebugLevel &gt; 1}">
				<gel:log level="debug" message="--vFileIN  : ${vFileIN}"/> 
				<gel:log level="debug" message="--vFileOUT : ${vFileOUT}"/>
			</core:if>
			<core:set var="vLine">Call %XOG_HOME%/xog -servername %SERVERNAME% -portnumber %PORTNUMBER% -sslenabled %SSLENABLED%  -username %USERNAME% -password %PASSWORD% -output ${vOutputPath}/${vFileOUT} -input ${vInputPath}/${vFileIN}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
		</core:forEach>
		<core:set var="vLine">pause</core:set>
		<file:line>
			<file:column value="${vLine}"/>
		</file:line>
	</file:writeFile>

	<sql:query escapeText="false" var="vPostInstall">
		select nvl(count(*),0)
		from ODF_CA_STPROJ_FILE
		Where ODF_PARENT_ID = ${vStudioProjectID}
		AND ELEMENT_TYPE != 'demodata'
		AND IS_POST_FILE = 1
	</sql:query>
	<core:forEach items="${vPostInstall.rowsByIndex}" var="row">
		<core:set var="vHasPostInstall">${row[0]}</core:set>
	</core:forEach>

	<core:if test="${vHasPostInstall &gt; 0}">
		<core:set var="vFileName">${vPackagingPath}/${vProjectCode}PostInstall.bat</core:set>
		<core:if test="${DebugLevel &gt; 0}">
			<gel:log level="debug" message="Creating Post File: ${vFileName}"/> 
		</core:if>
		
		<file:writeFile fileName="${vFileName}" delimiter="" embedded="0">
			<core:set var="vLine">@Echo Off</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET XOG_HOME=${vXOGHome}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET SERVERNAME=${vServername}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET PORTNUMBER=${vXOGPort}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET SSLENABLED=${vSSL}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET USERNAME=${vXOGUser}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET PASSWORD=${vXOGPassword}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">SET JAVA_HOME=${vXOGJava}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">CD ${vInputPath}</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
			<core:set var="vLine">IF NOT EXIST output md output</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>

			<sql:query escapeText="false" var="vProjectFiles">
				select filename, output_filename 
				from ODF_CA_STPROJ_FILE
				Where ODF_PARENT_ID = ${vStudioProjectID}
				AND ELEMENT_TYPE != 'demodata'
				AND IS_POST_FILE = 1
				ORDER BY sort_order
			</sql:query>
			<core:forEach items="${vProjectFiles.rowsByIndex}" var="row">
				<core:set var="vFileIN">${row[0]}</core:set>
				<core:set var="vFileOUT">${row[1]}</core:set>
				<core:if test="${DebugLevel &gt; 1}">
					<gel:log level="debug" message="--vFileIN  : ${vFileIN}"/> 
					<gel:log level="debug" message="--vFileOUT : ${vFileOUT}"/>
				</core:if>
				<core:set var="vLine">Call %XOG_HOME%/xog -servername %SERVERNAME% -portnumber %PORTNUMBER% -sslenabled %SSLENABLED%  -username %USERNAME% -password %PASSWORD% -output ${vOutputPath}/${vFileOUT} -input ${vInputPath}/${vFileIN}</core:set>
				<file:line>
					<file:column value="${vLine}"/>
				</file:line>
			</core:forEach>
			<core:set var="vLine">pause</core:set>
			<file:line>
				<file:column value="${vLine}"/>
			</file:line>
		</file:writeFile>
	</core:if>
	
</gel:script>