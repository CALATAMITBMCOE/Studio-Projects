<gel:script 
 xmlns:core="jelly:core" 
    xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
    xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary"
    xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"	    
    xmlns:sql="jelly:sql"
    xmlns:xog="http://www.niku.com/xog"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
    xmlns:util="jelly:util"
    xmlns:q="http://www.niku.com/xog/Query">
	
	<core:set var="DebugLevel">1</core:set>
	<core:set var="vFound">0</core:set>
	
	<core:set var="vStudioProjectID" value="${gel_objectInstanceId}"/>

    <gel:setDataSource dbId="Niku"/>

	<sql:query escapeText="false" var="vProject">
		select INITIALS, CODE, PARTITION_CODE, NAME, PROJECT_CODE
		from odf_ca_stproj_project
		Where id = ${vStudioProjectID}
	</sql:query>
	<core:forEach items="${vProject.rowsByIndex}" var="row">
		<core:set var="vProjectInitials">${row[0]}</core:set>
		<core:set var="vProjectCode">${row[1]}</core:set>
		<core:set var="vStudio_Part">${row[2]}</core:set>
		<core:set var="vStudioProjectName">${row[3]}</core:set>
		<core:set var="vProjectCodeName">${row[4]}</core:set>
	</core:forEach>
	
	<core:if test="${DebugLevel &gt; 0}">
		<gel:log level="debug" message="Start Script"/>
		<gel:log level="debug" message="Studio Project: ${vStudioProjectID}"/> 
	</core:if>

	<core:invokeStatic var="config" className="com.niku.union.config.ConfigurationManager" method="getInstance"/>
	<core:set var="vInstallDirInput" value="${config.getProperties().getDirectories().getInstallDir()}"/>
	<core:if test="${DebugLevel &gt; 1}">
		<gel:log level="debug" message="vInstallDirInput :  ${vInstallDirInput}"/>
	</core:if>
	
	<core:new className="java.lang.String" var="InputString" >
		<core:arg type="java.lang.String" value="${vInstallDirInput}" />
	</core:new>

	<core:invoke var="vInputStringCorrect" on="${InputString}" method="replaceAll">
		<core:arg type="java.lang.String" value="\\\\"/>
		<core:arg type="java.lang.String" value="\\"/>
	</core:invoke>

	<core:invoke var="vInstallDir" on="${vInputStringCorrect}" method="replace">
		<core:arg type="char" value="\"/>
		<core:arg type="char" value="/"/>
	</core:invoke>
	
	<core:if test="${DebugLevel &gt; 1}">
		<gel:log level="debug" message="vInstallDir :  ${vInstallDir}"/>
	</core:if>
	
	<core:set var="XOGlogFolder" value="${vInstallDir}/logs"/>
	<core:set var="publishdir">${vInstallDir}/webroot/StudioPackages/${vProjectCodeName}</core:set>
	<core:if test="${DebugLevel &gt; 0}">
		<gel:log level="debug" message="publishdir: ${publishdir}"/> 
	</core:if>
	
	<sql:query escapeText="false" var="vProject">
		select XLAT_SPREADSHEET, PUBLISH, OUT_FOLDER_PATH
		from odf_ca_stproj_project
		Where id = ${vStudioProjectID}
	</sql:query>
	<core:forEach items="${vProject.rowsByIndex}" var="row">
		<core:set var="vSpreadsheet">${row[0]}</core:set>
		<core:set var="vPublish">${row[1]}</core:set>
		<core:set var="vFolder">${row[2]}</core:set>
		<core:if test="${DebugLevel &gt; 1}">
			<gel:log level="debug" message="vSpreadsheet-Publish: ${vSpreadsheet}-${vPublish}"/> 
		</core:if>

		<core:set var="vSpreadsheetPublish">${vFolder}/${vSpreadsheet}</core:set>		
		<core:if test="${vPublish == 1}">
			<core:set var="vSpreadsheetPublish">${publishdir}/${vSpreadsheet}</core:set>		
		</core:if>
		
		<core:set var="regex">[,]</core:set>
		<core:new className="java.io.FileInputStream" var="vSheet">
			<core:arg type="java.lang.String" value="${vSpreadsheetPublish}" />
		</core:new>

		<core:new className="java.io.InputStreamReader" var="vSheetISR">
			<core:arg type="java.io.InputStream" value="${vSheet}" />
			<core:arg type="java.lang.String" value="ISO8859_1" />
		</core:new>

		<core:new className="java.io.BufferedReader" var="vData">
			<core:arg type="java.io.InputStreamReader" value="${vSheetISR}" />
		</core:new>

		<core:if test="${DebugLevel &gt; 1}">
			<gel:log level="debug" message="Encoding: ${vSheetISR.getEncoding()}"/>
		</core:if>

		<core:set var="vDataRow" value="${vData.readLine()}" />

		<core:while test="${vDataRow != null}">

			<core:set var="vDataRow" value="${vDataRow.split(regex)}" />

			<core:if test="${DebugLevel &gt; 2}">
				<gel:log level="debug" message="${vDataRow[0]}, ${vDataRow[1]}, ${vDataRow[2]}, ${vDataRow[3]}, ${vDataRow[4]}, ${vDataRow[5]}, ${vDataRow[6]}, ${vDataRow[7]}"/>
			</core:if>

			<core:set var="vCaptionIntID">${vDataRow[0]}</core:set>
			<core:set var="vCaptionName">${vDataRow[6]}</core:set>
			<core:set var="vCaptionDesc">${vDataRow[7]}</core:set>
			<core:if test="${DebugLevel &gt; 1}">
				<gel:log level="debug" message="vCaptionIntID:${vCaptionIntID}. vCaptionName:${vCaptionName}. vCaptionDesc:${vCaptionDesc}."/>
			</core:if>

			<core:if test="${(vCaptionIntID != 'InternalID') and (vCaptionIntID !='')}">
				<sql:update>
					update odf_ca_stproj_elem_xlat
					set caption_name = '${vCaptionName}', caption_descr = '${vCaptionDesc}', last_updated_date = sysdate
					where id = ${vCaptionIntID}
				</sql:update>	
			</core:if>
			
			<core:set var="vDataRow" value="${vData.readLine()}" />
			
		</core:while>
		<core:invoke method="close" on="${vData}" var="vOut"/>		
		<core:invoke method="close" on="${vSheetISR}" var="vOut"/>		
		<core:invoke method="close" on="${vSheet}" var="vOut"/>		
	</core:forEach>
	
</gel:script>